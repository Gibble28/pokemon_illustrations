<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pokémon Illustrations List — Free</title>
    <meta name="description" content="Browse Pokémon cards with images, illustrators, sets, rarities, and live prices from the Pokémon TCG API. Free, client‑side only." />
    <link rel="icon" href="https://assets.pokemon.com/static2/_ui/img/favicon.ico" />
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body { height: 100%; }
      body { background: linear-gradient(to bottom, #f8fafc, #f1f5f9); }
    </style>
    <!-- React 18 + ReactDOM (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel standalone to allow JSX in the browser (simple deploy) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      // --------- Helper: pick a single best price from TCGplayer price object ---------
      function extractBestPrice(card) {
        const p = card?.tcgplayer?.prices || {};
        const order = [
          "normal",
          "holofoil",
          "reverseHolofoil",
          "1stEditionNormal",
          "1stEditionHolofoil",
          "unlimitedHolofoil",
          "unlimited",
        ];
        for (const k of order) {
          const obj = p[k];
          if (!obj) continue;
          const price = obj.market ?? obj.mid ?? obj.directLow ?? obj.low ?? obj.high ?? null;
          if (price != null) return { key: k, price };
        }
        return null;
      }

      function useDebouncedValue(value, delay = 400) {
        const [v, setV] = useState(value);
        useEffect(() => {
          const t = setTimeout(() => setV(value), delay);
          return () => clearTimeout(t);
        }, [value, delay]);
        return v;
      }

      function CardItem({ card }) {
        const best = extractBestPrice(card);
        const price = best ? `$${best.price.toFixed(2)} (${best.key})` : "—";
        return (
          <div className="rounded-2xl shadow p-4 bg-white/60 backdrop-blur border flex gap-4">
            <img
              src={card.images?.small}
              alt={card.name}
              className="w-24 h-auto rounded-xl object-contain bg-white"
              loading="lazy"
            />
            <div className="flex-1 min-w-0">
              <div className="flex items-start justify-between gap-2">
                <h3 className="font-semibold text-lg leading-tight truncate">
                  {card.name}
                </h3>
                <div className="text-sm px-2 py-1 rounded-full bg-gray-100 shrink-0">
                  {price}
                </div>
              </div>
              <div className="text-sm text-gray-600 mt-1">
                <span className="mr-2">{card.set?.name}</span>
                <span className="mx-1">•</span>
                <span className="mr-2">{card.rarity || "—"}</span>
                <span className="mx-1">•</span>
                <span>#{card.number}</span>
              </div>
              {card.artist && (
                <div className="text-xs text-gray-500 mt-1">Illustrator: {card.artist}</div>
              )}
              <div className="mt-2 flex gap-2 flex-wrap">
                {card.types?.map((t) => (
                  <span key={t} className="text-xs px-2 py-1 bg-gray-100 rounded-full">
                    {t}
                  </span>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [apiKey, setApiKey] = useState(() => localStorage.getItem("ptcg_key") || "");
        const [query, setQuery] = useState("");
        const debouncedQuery = useDebouncedValue(query);
        const [rarity, setRarity] = useState("all");
        const [artist, setArtist] = useState("all");
        const [sort, setSort] = useState("price_desc");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [cards, setCards] = useState([]);
        const [page, setPage] = useState(1);
        const [hasMore, setHasMore] = useState(true);
        const sentinelRef = useRef(null);

        useEffect(() => {
          if (apiKey) localStorage.setItem("ptcg_key", apiKey);
        }, [apiKey]);

        const buildApiUrl = (pageNum) => {
          const filters = [];
          if (debouncedQuery.trim()) {
            const q = debouncedQuery.trim().replace(/\"/g, '\\\\"');
            filters.push(`name:*"${q}"*`);
          }
          if (rarity !== "all") {
            const r = rarity.replace(/\"/g, '\\"');
            filters.push(`rarity:"${r}"`);
          }
          if (artist !== "all") {
            const a = artist.replace(/\"/g, '\\"');
            filters.push(`artist:"${a}"`);
          }"`);
          }
          const qParam = filters.length ? `?q=${encodeURIComponent(filters.join(" "))}` : "?";
          const size = 48;
          const url = `https://api.pokemontcg.io/v2/cards${qParam}&page=${pageNum}&pageSize=${size}`;
          return url;
        };

        const fetchCards = async (pageNum, replace = false) => {
          setLoading(true);
          setError("");
          try {
            const res = await fetch(buildApiUrl(pageNum), {
              headers: apiKey ? { "X-Api-Key": apiKey } : {},
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            const items = json?.data || [];
            setCards((prev) => (replace ? items : [...prev, ...items]));
            const total = json?.totalCount ?? 0;
            const perPage = json?.pageSize ?? items.length;
            const upto = pageNum * (perPage || 48);
            setHasMore(upto < total);
          } catch (e) {
            setError(String(e.message || e));
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          setPage(1);
          fetchCards(1, true);
          // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [debouncedQuery, rarity, artist, apiKey]);

        useEffect(() => {
          if (!hasMore || loading) return;
          const el = sentinelRef.current;
          if (!el) return;
          const io = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
              const next = page + 1;
              setPage(next);
              fetchCards(next);
            }
          });
          io.observe(el);
          return () => io.disconnect();
        }, [hasMore, loading, page]);

        const sorted = useMemo(() => {
          const copy = [...cards];
          const getPrice = (c) => (extractBestPrice(c)?.price ?? Number.NEGATIVE_INFINITY);
          if (sort === "price_desc") copy.sort((a, b) => (getPrice(b) - getPrice(a)));
          if (sort === "price_asc") copy.sort((a, b) => (getPrice(a) - getPrice(b)));
          if (sort === "alpha") copy.sort((a, b) => a.name.localeCompare(b.name));
          return copy;
        }, [cards, sort]);

        const rarities = useMemo(() => {
          const s = new Set();
          cards.forEach((c) => c.rarity && s.add(c.rarity));
          return ["all", ...Array.from(s).sort()];
        }, [cards]);

        const artists = useMemo(() => {
          const s = new Set();
          cards.forEach((c) => c.artist && s.add(c.artist));
          return ["all", ...Array.from(s).sort((a,b)=>a.localeCompare(b))];
        }, [cards]);

        return (
          <div className="min-h-screen">
            <header className="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
              <div className="max-w-6xl mx-auto p-4 flex flex-col gap-3 md:flex-row md:items-end md:gap-4">
                <div className="flex-1">
                  <h1 className=\"text-2xl font-bold\">Pokémon Illustrations List</h1>
                  <p className="text-sm text-gray-600">Browse all Pokémon card illustrations with pictures, artists, sets, rarities, and prices. Paste your Pokémon TCG API key to enable price data.</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 w-full md:w-auto">
                  <input
                    type="password"
                    className="border rounded-xl px-3 py-2 text-sm"
                    placeholder="X-Api-Key"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                  />
                  <input
                    type="text"
                    className="border rounded-xl px-3 py-2 text-sm"
                    placeholder="Search by name… (e.g., Charizard)"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                  />
                </div>
                <div className="flex gap-2 flex-wrap">
                  <select
                    className="border rounded-xl px-3 py-2 text-sm"
                    value={artist}
                    onChange={(e) => setArtist(e.target.value)}
                  >
                    {artists.map((a) => (
                      <option key={a} value={a}>{a}</option>
                    ))}
                  </select>
                  <select
                    className="border rounded-xl px-3 py-2 text-sm"
                    value={rarity}
                    onChange={(e) => setRarity(e.target.value)}
                  >
                    {rarities.map((r) => (
                      <option key={r} value={r}>{r}</option>
                    ))}
                  </select>
                  <select
                    className="border rounded-xl px-3 py-2 text-sm"
                    value={sort}
                    onChange={(e) => setSort(e.target.value)}
                  >
                    <option value="price_desc">Sort: Price ↓</option>
                    <option value="price_asc">Sort: Price ↑</option>
                    <option value="alpha">Sort: A → Z</option>
                  </select>
                </div>
              </div>
            </header>

            <main className="max-w-6xl mx-auto p-4">
              {error && (
                <div className="mb-4 p-3 rounded-xl border bg-red-50 text-red-700">
                  Error: {error}. Make sure your API key is valid.
                </div>
              )}

              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {sorted.map((c) => (
                  <CardItem key={c.id} card={c} />
                ))}
              </div>

              <div ref={sentinelRef} className="h-12 flex items-center justify-center">
                {loading && <span className="text-sm text-gray-600">Loading…</span>}
                {!hasMore && !loading && (
                  <span className="text-sm text-gray-500">End of results</span>
                )}
              </div>
            </main>

            <footer className="max-w-6xl mx-auto p-6 text-xs text-gray-500">
              <p>
                Data & images from Pokémon TCG API. Prices surface TCGplayer/Cardmarket feeds when available. This project is for personal, non-commercial use.
              </p>
            </footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
